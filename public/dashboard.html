<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Wareify | Admin Dashboard</title>
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="main-header">
            <img src="Wareify-logo.jpg" alt="Wareify Logo" />
            <h1>Wareify Dashboard</h1>
        </div>
        <div class="header-actions">
            <button id="themeToggle" class="theme-toggle">‚òÄÔ∏è</button>
            <span>üîî</span>
        </div>
    </header>
    <div class="sidebar">
        <a href="dashboard.html" class="active">üè† Dashboard</a>
        <a href="add-item.html">‚ûï Add Item</a>
        <a href="blockchain.html">üîó Blockchain</a>
        <a href="user-management.html" id="userManagementLink" style="display: none;">üë• User Management</a>
        <a href="add-shipments.html">üöö Add Shipments</a>
        <a href="pending-shipments.html">‚è≥ Pending Shipments</a> 
        <a href="track-shipments.html">üì¶ Track Shipments</a>
        <a href="recent-transactions.html">üßæ Recent Transactions</a>
        <a href="#" id="logoutButton" class="logout-button">üö™ Logout</a>
    </div>
    <div class="main-content" id="mainContent">
        <p class="welcome">Welcome back, Admin!</p>
        <div class="stats">
            <div class="card"><h3>Total Products</h3><p id="productCount">-</p></div>
            <div class="card"><h3>Active Orders</h3><p>5</p></div>
            <div class="card"><h3>Inventory Value</h3><p>$<span id="inventoryValue">0</span></p></div>
            <div class="card"><h3>Pending Shipments</h3><p>2</p></div>
        </div>
        <div class="content-section">
            <div class="left">
                <div class="chart">
                    <h3>Inventory Summary</h3>
                    <p>üì¶ Categories: <strong id="categoryCount">-</strong> | üßÆ Items: <strong id="totalItems">-</strong> | ‚ö†Ô∏è Low Stock: <strong id="lowStockCount">-</strong></p>
                    <canvas id="stockChart" style="max-width: 200px; max-height: 200px; margin: auto;"></canvas>
                </div>
            </div>
            <div class="right">
                <div class="transactions">
                    <h3>Recent Transactions</h3>
                    <ul id="dashboardTransactionsList">
                        <li>Loading transactions...</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="products">
            <div class="products-header">
                <h3>Registered Products</h3>
                <div class="search-bar-container">
                    <input type="text" id="productSearchInput" placeholder="Search by product name..." class="search-input">
                    <button id="searchButton" class="search-button">Search</button>
                    <button id="clearSearchButton" class="clear-search-button" style="display:none;">Clear</button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Price</th>
                        <th>Stock</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="productTableBody"></tbody>
            </table>
        </div>
        <footer>
            ¬© 2025 Wareify. All rights reserved.
        </footer>
    </div>

    <div id="productDetailsModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <button class="modal-close-button" id="closeModalButton">&times;</button>
            <div id="modalLoading" style="display: none; text-align: center; padding: 20px;">Loading product details...</div>
            <div id="modalErrorMessage" class="error-message" style="display: none; text-align: center; padding: 20px;"></div>

            <div id="modalProductDetails" style="display: none;">
                <img id="modalProductImage" class="modal-product-image" src="" alt="Product Image">
                <h2 id="modalProductName" class="modal-product-name"></h2>
                <div class="modal-product-info-grid">
                    <p><strong>Category:</strong> <span id="modalProductCategory"></span></p>
                    <p><strong>Price:</strong> $<span id="modalProductPrice"></span></p>
                    <p><strong>Stock:</strong> <span id="modalProductStock"></span></p>
                    <p><strong>Description:</strong> <span id="modalProductDescription"></span></p>
                    <p><strong>Manufacturer:</strong> <span id="modalProductManufacturer"></span></p>
                    <p><strong>Manufactured Date:</strong> <span id="modalProductManufacturedAt"></span></p>
                    <p><strong>Selling Location:</strong> <span id="modalProductSellingLocation"></span></p>
                    <p><strong>Batch No:</strong> <span id="modalProductBatchNo"></span></p>
                    <p><strong>Record Timestamp:</strong> <span id="modalProductTimestamp"></span></p>
                </div>
                <div id="modalAdminActions" class="modal-admin-actions" style="display: none;">
                    <button id="modalEditProductButton" class="modal-action-btn modal-edit-btn">Edit Product</button>
                    <button id="modalDeleteProductButton" class="modal-action-btn modal-delete-btn">Delete Product</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/logout.js"></script>
    
    <script>
        // This is your original, large script for the main dashboard functionality.
        // It remains unchanged.
        async function loadProducts(searchTerm = '') {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("You are not logged in.");
                window.location.href = "login.html";
                return;
            }
            try {
                const res = await fetch("http://localhost:3000/products", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    }
                });
                if (!res.ok) {
                    const errorData = await res.json();
                    alert("Failed to load products: " + errorData.message);
                    return;
                }
                let products = await res.json();
                if (searchTerm) {
                    const lowerCaseSearchTerm = searchTerm.toLowerCase();
                    products = products.filter(product =>
                        product.name.toLowerCase().includes(lowerCaseSearchTerm)
                    );
                }
                const tbody = document.getElementById("productTableBody");
                tbody.innerHTML = "";
                let totalValue = 0;
                document.getElementById("productCount").textContent = products.length;
                if (products.length === 0 && searchTerm) {
                    const noResultsRow = document.createElement("tr");
                    noResultsRow.innerHTML = `<td colspan="8" class="text-center py-4 text-gray-500">No products found matching "${searchTerm}".</td>`;
                    tbody.appendChild(noResultsRow);
                } else {
                    products.forEach((product, index) => {
                        totalValue += product.price * product.stock;
                        const row = document.createElement("tr");
                        row.style.cursor = 'pointer';
                        row.onclick = () => {
                            openProductDetailsModal(product._id);
                        };
                        row.innerHTML = `
                            <td>#${String(index + 1).padStart(3, '0')}</td>
                            <td style="width: 60px; text-align: center;">
                                ${product.image ? `<img src="http://localhost:3000${product.image}" style="height: 40px; width: 40px; object-fit: cover; border-radius: 4px;" />` : '‚Äî'}
                            </td>
                            <td>${product.name}</td>
                            <td>${product.category}</td>
                            <td>$${product.price}</td>
                            <td>${product.stock}</td>
                            <td><span class="status ${product.stock < 10 ? 'low' : 'active'}">
                                ${product.stock < 10 ? 'Low Stock' : 'Active'}</span></td>
                            <td>
                                ${localStorage.getItem("role") === "admin" ? `
                                    <button class="action-btn edit-btn" onclick="event.stopPropagation(); window.location.href='edit-product.html?id=${product._id}'">Edit</button>
                                    <button class="action-btn delete-btn" onclick="event.stopPropagation(); deleteProduct('${product._id}')">Delete</button>
                                ` : "‚Äî"}
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
                document.getElementById("inventoryValue").textContent = totalValue.toLocaleString();
            } catch (err) {
                console.error("Failed to load products", err);
            }
        }
        async function deleteProduct(id) {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("You are not logged in.");
                window.location.href = "login.html";
                return;
            }
            if (!confirm("Are you sure you want to delete this product?")) return;
            try {
                const res = await fetch(`http://localhost:3000/product/${id}`, {
                    method: "DELETE",
                    headers: { "Authorization": "Bearer " + token }
                });
                const result = await res.json();
                if (res.ok) {
                    alert(result.message);
                    loadProducts();
                    loadInventorySummary();
                    closeProductDetailsModal();
                } else {
                    alert("Deletion failed: " + result.message);
                }
            } catch (err) {
                console.error("Delete failed", err);
                alert("An error occurred during deletion.");
            }
        }
        async function loadInventorySummary() {
            const token = localStorage.getItem("token");
            if (!token) return;
            try {
                const res = await fetch("http://localhost:3000/inventory-summary", {
                    headers: { "Authorization": "Bearer " + token }
                });
                const summary = await res.json();
                document.getElementById("totalItems").textContent = summary.totalItems;
                document.getElementById("categoryCount").textContent = summary.totalCategories;
                document.getElementById("lowStockCount").textContent = summary.lowStock;
                const ctx = document.getElementById("stockChart").getContext("2d");
                if (window.myStockChart) {
                    window.myStockChart.destroy();
                }
                window.myStockChart = new Chart(ctx, {
                    type: "doughnut",
                    data: {
                        labels: ["Active Stock", "Low Stock"],
                        datasets: [{
                            data: [summary.totalItems - summary.lowStock, summary.lowStock],
                            backgroundColor: ["#28a745", "#ffc107"]
                        }]
                    },
                    options: {
                        responsive: true,
                        cutout: "60%"
                    }
                });
            } catch (err) {
                console.error("Inventory summary error", err);
            }
        }
        function setupThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            const body = document.body;
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                body.classList.add('dark-mode');
                themeToggle.textContent = 'üåô';
            } else {
                themeToggle.textContent = '‚òÄÔ∏è';
            }
            themeToggle.addEventListener('click', () => {
                body.classList.toggle('dark-mode');
                if (body.classList.contains('dark-mode')) {
                    localStorage.setItem('theme', 'dark');
                    themeToggle.textContent = 'üåô';
                } else {
                    localStorage.setItem('theme', 'light');
                    themeToggle.textContent = '‚òÄÔ∏è';
                }
            });
        }
        const productDetailsModal = document.getElementById('productDetailsModal');
        const modalLoading = document.getElementById('modalLoading');
        const modalErrorMessage = document.getElementById('modalErrorMessage');
        const modalProductDetails = document.getElementById('modalProductDetails');
        const mainContent = document.getElementById('mainContent');
        async function openProductDetailsModal(productId) {
            productDetailsModal.style.display = 'flex';
            modalLoading.style.display = 'block';
            modalErrorMessage.style.display = 'none';
            modalProductDetails.style.display = 'none';
            mainContent.classList.add('blurred');
            const token = localStorage.getItem("token");
            if (!token) {
                modalErrorMessage.textContent = "Authentication required to view product details.";
                modalErrorMessage.style.display = 'block';
                modalLoading.style.display = 'none';
                return;
            }
            try {
                const res = await fetch(`http://localhost:3000/product/${productId}`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    }
                });
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || "Failed to fetch product details.");
                }
                const product = await res.json();
                document.getElementById('modalProductImage').src = product.image ? `http://localhost:3000${product.image}` : 'https://placehold.co/150x150?text=No+Image';
                document.getElementById('modalProductName').textContent = product.name;
                document.getElementById('modalProductCategory').textContent = product.category;
                document.getElementById('modalProductPrice').textContent = product.price ? product.price.toFixed(2) : '0.00';
                document.getElementById('modalProductStock').textContent = product.stock;
                document.getElementById('modalProductDescription').textContent = product.description || 'N/A';
                document.getElementById('modalProductManufacturer').textContent = product.manufacturer || 'N/A';
                document.getElementById('modalProductManufacturedAt').textContent = product.manufacturedAt ? new Date(product.manufacturedAt).toLocaleDateString() : 'N/A';
                document.getElementById('modalProductSellingLocation').textContent = product.sellingLocation || 'N/A';
                document.getElementById('modalProductBatchNo').textContent = product.batchNo || 'N/A';
                document.getElementById('modalProductTimestamp').textContent = product.timestamp ? new Date(product.timestamp).toLocaleString() : 'N/A';
                const role = localStorage.getItem("role");
                const modalAdminActions = document.getElementById('modalAdminActions');
                if (role === "admin") {
                    modalAdminActions.style.display = 'block';
                    document.getElementById('modalEditProductButton').onclick = () => {
                        window.location.href = `edit-product.html?id=${product._id}`;
                    };
                    document.getElementById('modalDeleteProductButton').onclick = () => {
                        deleteProduct(product._id);
                    };
                } else {
                    modalAdminActions.style.display = 'none';
                }
                modalLoading.style.display = 'none';
                modalProductDetails.style.display = 'block';
            } catch (err) {
                console.error("Error fetching product details:", err);
                modalErrorMessage.textContent = "Could not load product details: " + err.message;
                modalErrorMessage.style.display = 'block';
                modalLoading.style.display = 'none';
                modalProductDetails.style.display = 'none';
            }
        }
        function closeProductDetailsModal() {
            productDetailsModal.style.display = 'none';
            mainContent.classList.remove('blurred');
        }
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem("token");
            const role = localStorage.getItem("role");
            if (!token) {
                alert("You must log in first.");
                window.location.href = "login.html";
                return;
            }
            if (role === "staff") { // Redirect staff to a different dashboard
                window.location.href = "staff-dashboard.html";
                return;
            }
            // Only show User Management for admins
            if (role === "admin") {
                 document.getElementById("userManagementLink").style.display = "block";
            }
            loadProducts();
            loadInventorySummary();
            setupThemeToggle();
            document.getElementById('logoutButton').addEventListener('click', (event) => {
                event.preventDefault();
                localStorage.removeItem('token');
                localStorage.removeItem('role');
                window.location.href = 'login.html';
            });
            const productSearchInput = document.getElementById('productSearchInput');
            const searchButton = document.getElementById('searchButton');
            const clearSearchButton = document.getElementById('clearSearchButton');
            searchButton.addEventListener('click', () => {
                const searchTerm = productSearchInput.value.trim();
                loadProducts(searchTerm);
                clearSearchButton.style.display = searchTerm ? 'inline-block' : 'none';
            });
            clearSearchButton.addEventListener('click', () => {
                productSearchInput.value = '';
                loadProducts('');
                clearSearchButton.style.display = 'none';
            });
            productSearchInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    searchButton.click();
                }
            });
            document.getElementById('closeModalButton').addEventListener('click', closeProductDetailsModal);
            productDetailsModal.addEventListener('click', (event) => {
                if (event.target === productDetailsModal) {
                    closeProductDetailsModal();
                }
            });
        });
    </script>
    
    <script>
        async function loadDashboardTransactions() {
            const list = document.getElementById("dashboardTransactionsList");
            const token = localStorage.getItem("token");
            if (!token) return;

            try {
                // NOTE: Make sure you have a `/recent-transactions` endpoint in your server.js
                // For now, this will use the 'shipments' data from localStorage as a fallback.
                const shipments = JSON.parse(localStorage.getItem("shipments")) || [];
                
                list.innerHTML = ""; // clear old dummy items

                if (!shipments || shipments.length === 0) {
                    list.innerHTML = "<li>No recent transactions</li>";
                    return;
                }

                // Show up to 3 latest transactions
                shipments.slice(0, 3).forEach(tx => {
                    const li = document.createElement("li");
                    li.innerHTML = `
                        <span>Order #${tx.id || tx._id || "N/A"} - ${tx.itemName || "Unknown"}</span>
                        <span class="badge ${getStatusClass(tx.status)}">${tx.status || "‚Äî"}</span>
                    `;
                    list.appendChild(li);
                });
            } catch (err) {
                console.error("Error loading dashboard transactions:", err);
                list.innerHTML = "<li>‚ö†Ô∏è Failed to load</li>";
            }
        }

        function getStatusClass(status) {
            if (!status) return "";
            switch (status.toLowerCase()) {
                case "completed":
                case "delivered":
                    return "completed";
                case "pending":
                case "approved":
                    return "pending";
                case "in transit":
                case "processing":
                    return "transit";
                default: return "";
            }
        }

        // Call when dashboard loads
        document.addEventListener("DOMContentLoaded", loadDashboardTransactions);
    </script>
</body>
</html>